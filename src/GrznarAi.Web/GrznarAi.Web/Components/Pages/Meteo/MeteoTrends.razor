@page "/meteo/trends"
@inject IWeatherHistoryService WeatherHistoryService
@inject ILocalizationService Localizer
@using GrznarAi.Web.Data
@using GrznarAi.Web.Services
@using System.Globalization
@using Radzen
@using Radzen.Blazor
@rendermode InteractiveServer

<PageTitle>@Localizer.GetString("Meteo.Trends.Title") - GrznarAI</PageTitle>

<div class="meteo-trends-container">
    <h1>@Localizer.GetString("Meteo.Trends.Title")</h1>
    
    <div class="period-selector mb-4">
        <div class="period-controls">
            <div class="period-types mb-2">
                <div class="btn-group" role="group">
                    <input type="radio" class="btn-check" name="periodOption" id="dayOption" autocomplete="off"
                           checked="@(SelectedPeriod == PeriodType.Day)" 
                           @onchange="@(() => ChangePeriod(PeriodType.Day))" />
                    <label class="btn btn-outline-primary" for="dayOption">@Localizer.GetString("Meteo.Trends.Day")</label>

                    <input type="radio" class="btn-check" name="periodOption" id="weekOption" autocomplete="off"
                           checked="@(SelectedPeriod == PeriodType.Week)" 
                           @onchange="@(() => ChangePeriod(PeriodType.Week))" />
                    <label class="btn btn-outline-primary" for="weekOption">@Localizer.GetString("Meteo.Trends.Week")</label>

                    <input type="radio" class="btn-check" name="periodOption" id="monthOption" autocomplete="off"
                           checked="@(SelectedPeriod == PeriodType.Month)" 
                           @onchange="@(() => ChangePeriod(PeriodType.Month))" />
                    <label class="btn btn-outline-primary" for="monthOption">@Localizer.GetString("Meteo.Trends.Month")</label>

                    <input type="radio" class="btn-check" name="periodOption" id="yearOption" autocomplete="off"
                           checked="@(SelectedPeriod == PeriodType.Year)" 
                           @onchange="@(() => ChangePeriod(PeriodType.Year))" />
                    <label class="btn btn-outline-primary" for="yearOption">@Localizer.GetString("Meteo.Trends.Year")</label>
                </div>
            </div>
                
            <div class="date-selector">
                @switch (SelectedPeriod)
                {
                    case PeriodType.Day:
                        <RadzenDatePicker @bind-Value="SelectedDate" DateFormat="d" Change="@(() => LoadData())" Class="date-picker" />
                        break;
                    case PeriodType.Week:
                        <div class="d-flex align-items-center">
                            <RadzenDatePicker @bind-Value="SelectedDate" DateFormat="d" Change="@(() => LoadWeekData())" Class="date-picker" />
                            <span class="date-range mx-2">@FirstDayOfWeek.ToString("d") &ndash; @LastDayOfWeek.ToString("d")</span>
                        </div>
                        break;
                    case PeriodType.Month:
                        <div class="d-flex align-items-center gap-2 month-year-selector">
                            <RadzenDropDown @bind-Value="SelectedMonth" Data="@Months" TextProperty="Text" ValueProperty="Value" 
                                          Change="@(() => LoadMonthData())" Class="month-dropdown" />
                            <RadzenDropDown @bind-Value="SelectedYear" Data="@Years" TextProperty="Text" ValueProperty="Value" 
                                          Change="@(() => LoadMonthData())" Class="year-dropdown" />
                        </div>
                        break;
                    case PeriodType.Year:
                        <RadzenDropDown @bind-Value="SelectedYear" Data="@Years" TextProperty="Text" ValueProperty="Value" 
                                      Change="@(() => LoadData())" Class="year-dropdown" />
                        break;
                }
            </div>
        </div>
    </div>
    
    @if (IsLoading)
    {
        <div class="loading-overlay">
            <div class="spinner">
                <span class="visually-hidden">@Localizer.GetString("Meteo.Loading")</span>
            </div>
        </div>
    }
    else if (WeatherData == null || !WeatherData.Any())
    {
        <div class="alert alert-info">
            @Localizer.GetString("Meteo.Trends.NoData")
        </div>
    }
    else
    {
        <div class="trend-charts">
            <!-- Graf teplot -->
            <div class="chart-container">
                <h2>@Localizer.GetString("Meteo.Trends.Temperature")</h2>
                <RadzenChart>
                    <RadzenLegend Position="LegendPosition.Bottom" />
                    
                    <RadzenCategoryAxis Step="@GetDateAxisStep()">
                        <RadzenAxisTitle Text="@GetDateAxisTitle()" />
                        <RadzenGridLines Visible="true" />
                        <RadzenAxisTicks Visible="true" />
                        <RadzenAxisOptions Padding="20" />
                        <RadzenAxisLabels Rotation="@GetAxisLabelRotation()" FormatString="@GetAxisLabelFormat()" />
                    </RadzenCategoryAxis>
                    
                    <RadzenValueAxis>
                        <RadzenAxisTitle Text="@Localizer.GetString("Meteo.Trends.Temperature")" />
                        <RadzenGridLines Visible="true" />
                        <RadzenAxisTicks Visible="true" />
                        <RadzenAxisOptions Padding="20" />
                    </RadzenValueAxis>
                    
                    <RadzenLineSeries Smooth="true" Data="@WeatherData" CategoryProperty="Date" Title="@Localizer.GetString("Meteo.Trends.MinTemperature")" 
                                     ValueProperty="TemperatureOut">
                        <RadzenSeriesDataLabels Visible="false" />
                        <RadzenMarkers MarkerType="MarkerType.Circle" Size="5" />
                        <RadzenCategoryAxisTitle Text="@GetDateAxisTitle()" />
                        <RadzenValueAxisTitle Text="°C" />
                    </RadzenLineSeries>
                    
                    <RadzenLineSeries Smooth="true" Data="@WeatherData" CategoryProperty="Date" Title="@Localizer.GetString("Meteo.Trends.AvgTemperature")" 
                                     ValueProperty="AvgTemperature" LineType="LineType.Dashed">
                        <RadzenSeriesDataLabels Visible="false" />
                        <RadzenMarkers MarkerType="MarkerType.Square" Size="5" />
                    </RadzenLineSeries>
                    
                    <RadzenLineSeries Smooth="true" Data="@WeatherData" CategoryProperty="Date" Title="@Localizer.GetString("Meteo.Trends.MaxTemperature")" 
                                     ValueProperty="MaxTemperature">
                        <RadzenSeriesDataLabels Visible="false" />
                        <RadzenMarkers MarkerType="MarkerType.Diamond" Size="5" />
                    </RadzenLineSeries>

                    <RadzenChartTooltipOptions Visible="true" />
                </RadzenChart>
                
                @if (WeatherData != null && WeatherData.Any())
                {
                    <div class="temperature-summary-container">
                        <div class="temperature-summary">
                            <span class="temp-min">Min @GetMinTemperature() °C</span>
                            <span class="temp-avg">Prům @GetAvgTemperature() °C</span>
                            <span class="temp-max">Max @GetMaxTemperature() °C</span>
                        </div>
                    </div>
                }
            </div>
        </div>
    }
</div>

@code {
    private enum PeriodType
    {
        Day,
        Week,
        Month,
        Year
    }
    
    private PeriodType SelectedPeriod { get; set; } = PeriodType.Day;
    private DateTime SelectedDate { get; set; } = DateTime.Today;
    private int SelectedMonth { get; set; }
    private int SelectedYear { get; set; }
    
    private DateTime FirstDayOfWeek { get; set; }
    private DateTime LastDayOfWeek { get; set; }
    
    private List<WeatherHistory> WeatherData { get; set; }
    private bool IsLoading { get; set; } = false;
    
    private List<DropDownItem> Years { get; set; } = new List<DropDownItem>();
    private List<DropDownItem> Months { get; set; } = new List<DropDownItem>();
    
    private class DropDownItem
    {
        public string Text { get; set; }
        public int Value { get; set; }
    }
    
    protected override async Task OnInitializedAsync()
    {
        // Inicializace seznamů pro dropdown
        InitializeDropdowns();
        
        // Nastavení výchozích hodnot
        SelectedYear = DateTime.Today.Year;
        SelectedMonth = DateTime.Today.Month;
        
        // Výpočet týdne
        CalculateWeekDates();
        
        // Načtení dat pro výchozí období
        await LoadData();
    }
    
    private void InitializeDropdowns()
    {
        // Roky
        int currentYear = DateTime.Today.Year;
        for (int year = currentYear - 5; year <= currentYear; year++)
        {
            Years.Add(new DropDownItem { Text = year.ToString(), Value = year });
        }
        
        // Měsíce
        for (int month = 1; month <= 12; month++)
        {
            Months.Add(new DropDownItem 
            { 
                Text = CultureInfo.CurrentCulture.DateTimeFormat.GetMonthName(month), 
                Value = month 
            });
        }
    }
    
    private void CalculateWeekDates()
    {
        DayOfWeek firstDayOfWeek = CultureInfo.CurrentCulture.DateTimeFormat.FirstDayOfWeek;
        int diff = SelectedDate.DayOfWeek - firstDayOfWeek;
        if (diff < 0) diff += 7;
        
        FirstDayOfWeek = SelectedDate.AddDays(-diff);
        LastDayOfWeek = FirstDayOfWeek.AddDays(6);
    }
    
    private async Task ChangePeriod(PeriodType periodType)
    {
        SelectedPeriod = periodType;
        
        if (periodType == PeriodType.Week)
        {
            CalculateWeekDates();
            await LoadWeekData();
        }
        else if (periodType == PeriodType.Month)
        {
            await LoadMonthData();
        }
        else
        {
            await LoadData();
        }
    }
    
    private async Task LoadData()
    {
        IsLoading = true;
        try
        {
            DateTime startDate;
            DateTime endDate;
            
            switch (SelectedPeriod)
            {
                case PeriodType.Day:
                    startDate = SelectedDate.Date;
                    endDate = startDate.AddDays(1).AddSeconds(-1);
                    break;
                    
                case PeriodType.Week:
                    CalculateWeekDates();
                    startDate = FirstDayOfWeek;
                    endDate = LastDayOfWeek.AddDays(1).AddSeconds(-1);
                    break;
                    
                case PeriodType.Month:
                    startDate = new DateTime(SelectedYear, SelectedMonth, 1);
                    endDate = startDate.AddMonths(1).AddSeconds(-1);
                    break;
                    
                case PeriodType.Year:
                    startDate = new DateTime(SelectedYear, 1, 1);
                    endDate = startDate.AddYears(1).AddSeconds(-1);
                    break;
                    
                default:
                    startDate = SelectedDate.Date;
                    endDate = startDate.AddDays(1).AddSeconds(-1);
                    break;
            }
            
            WeatherData = await WeatherHistoryService.GetHistoryAsync(startDate, endDate);
            
            // Výpočet průměrů pro grafy
            CalculateAverages();
        }
        catch (Exception ex)
        {
            Console.Error.WriteLine($"Error loading weather data: {ex.Message}");
            WeatherData = new List<WeatherHistory>();
        }
        finally
        {
            IsLoading = false;
            StateHasChanged();
        }
    }
    
    private async Task LoadWeekData()
    {
        CalculateWeekDates();
        await LoadData();
    }
    
    private async Task LoadMonthData()
    {
        await LoadData();
    }
    
    private void CalculateAverages()
    {
        if (WeatherData == null || !WeatherData.Any())
            return;
        
        switch (SelectedPeriod)
        {
            case PeriodType.Day:
                // Pro denní pohled použijeme hodinové intervaly
                var hourlyData = WeatherData
                    .GroupBy(d => new DateTime(d.Date.Year, d.Date.Month, d.Date.Day, d.Date.Hour, 0, 0))
                    .Select(g => {
                        var first = g.First();
                        // Explicitně nastavíme datum s přesnou hodinou (zaokrouhleno na celé hodiny)
                        first.Date = new DateTime(first.Date.Year, first.Date.Month, first.Date.Day, first.Date.Hour, 0, 0);
                        first.AvgTemperature = g.Average(x => x.TemperatureOut);
                        first.MaxTemperature = g.Max(x => x.TemperatureOut);
                        return first;
                    })
                    .OrderBy(d => d.Date)
                    .ToList();
                
                WeatherData = hourlyData;
                break;
                
            case PeriodType.Week:
                // Pro týdenní pohled použijeme 4hodinové intervaly
                var fourHourData = WeatherData
                    .GroupBy(d => new DateTime(d.Date.Year, d.Date.Month, d.Date.Day, (d.Date.Hour / 4) * 4, 0, 0))
                    .Select(g => {
                        var first = g.First();
                        // Explicitně nastavíme datum s 4hodinovým zaokrouhlením
                        first.Date = new DateTime(first.Date.Year, first.Date.Month, first.Date.Day, (first.Date.Hour / 4) * 4, 0, 0);
                        first.AvgTemperature = g.Average(x => x.TemperatureOut);
                        first.MaxTemperature = g.Max(x => x.TemperatureOut);
                        first.TemperatureOut = g.Min(x => x.TemperatureOut); // Min hodnota jako TemperatureOut
                        return first;
                    })
                    .OrderBy(d => d.Date)
                    .ToList();
                
                WeatherData = fourHourData;
                break;
                
            case PeriodType.Month:
                // Pro měsíční pohled použijeme denní intervaly
                var dailyData = WeatherData
                    .GroupBy(d => d.Date.Date)
                    .Select(g => {
                        var first = g.First();
                        // Ujistíme se, že datum má jen den bez času
                        first.Date = first.Date.Date;
                        first.AvgTemperature = g.Average(x => x.TemperatureOut);
                        first.MaxTemperature = g.Max(x => x.TemperatureOut);
                        first.TemperatureOut = g.Min(x => x.TemperatureOut); // Min hodnota jako TemperatureOut
                        return first;
                    })
                    .OrderBy(d => d.Date)
                    .ToList();
                
                WeatherData = dailyData;
                break;
                
            case PeriodType.Year:
                // Pro roční pohled použijeme týdenní intervaly (7 dní)
                var startOfYear = new DateTime(SelectedYear, 1, 1);
                var weeklyData = WeatherData
                    .GroupBy(d => {
                        int dayOfYear = d.Date.DayOfYear;
                        int weekOfYear = (dayOfYear - 1) / 7;
                        return startOfYear.AddDays(weekOfYear * 7);
                    })
                    .Select(g => {
                        var first = g.First();
                        // Nastavíme datum na začátek týdne
                        int dayOfYear = first.Date.DayOfYear;
                        int weekOfYear = (dayOfYear - 1) / 7;
                        first.Date = startOfYear.AddDays(weekOfYear * 7);
                        
                        first.AvgTemperature = g.Average(x => x.TemperatureOut);
                        first.MaxTemperature = g.Max(x => x.TemperatureOut);
                        first.TemperatureOut = g.Min(x => x.TemperatureOut); // Min hodnota jako TemperatureOut
                        return first;
                    })
                    .OrderBy(d => d.Date)
                    .ToList();
                
                WeatherData = weeklyData;
                break;
        }
        
        StateHasChanged();
    }

    // Funkce pro formátování datumu v grafu podle vybraného období
    private string GetDateAxisTitle()
    {
        switch (SelectedPeriod)
        {
            case PeriodType.Day:
                return Localizer.GetString("Meteo.Trends.Hours");
            case PeriodType.Week:
                return Localizer.GetString("Meteo.Trends.FourHourInterval");
            case PeriodType.Month:
                return Localizer.GetString("Meteo.Trends.Days");
            case PeriodType.Year:
                return Localizer.GetString("Meteo.Trends.Weeks");
            default:
                return Localizer.GetString("Meteo.Trends.DateTime");
        }
    }

    // Formát datumů pro osu X podle zvoleného období
    private string GetDateFormatString()
    {
        switch (SelectedPeriod)
        {
            case PeriodType.Day:
                return "HH:mm"; // Jen hodiny a minuty pro denní pohled
            case PeriodType.Week:
                return "d.M. HH:mm"; // Zkrácené datum a čas pro týdenní pohled
            case PeriodType.Month:
                return "d.M."; // Zkrácené datum pro měsíční pohled
            case PeriodType.Year:
                return "d.M."; // Zkrácené datum pro roční pohled
            default:
                return "g"; // Výchozí formát
        }
    }

    // Nastavení počtu kroků na ose X podle období a počtu bodů v datech
    private int GetDateAxisStep()
    {
        if (WeatherData == null || !WeatherData.Any())
            return 1;

        int dataCount = WeatherData.Count;
        
        switch (SelectedPeriod)
        {
            case PeriodType.Day:
                // Pro denní pohled zobrazíme max. 12 popisků
                return Math.Max(1, dataCount / 12);
            case PeriodType.Week:
                // Pro týdenní pohled zobrazujeme max. 12 popisků (obvykle každých 6 hodin)
                return Math.Max(1, dataCount / 12);
            case PeriodType.Month:
                // Pro měsíční pohled zobrazíme max. 10 popisků
                return Math.Max(1, dataCount / 10);
            case PeriodType.Year:
                // Pro roční pohled zobrazíme max. 12 popisků (po měsících)
                return Math.Max(1, dataCount / 12);
            default:
                return 1;
        }
    }

    // Získání optimální rotace popisků podle typu období
    private double GetAxisLabelRotation()
    {
        switch (SelectedPeriod)
        {
            case PeriodType.Day:
                return 0; // Bez rotace pro denní zobrazení
            case PeriodType.Week:
                return 45; // 45 stupňů pro týdenní zobrazení
            case PeriodType.Month:
                return 45; // 45 stupňů pro měsíční zobrazení
            case PeriodType.Year:
                return 45; // 45 stupňů pro roční zobrazení
            default:
                return 0;
        }
    }

    // Funkce pro formátování osy X podle vybraného období
    private string GetAxisLabelFormat()
    {
        return "{0:" + GetDateFormatString() + "}";
    }

    // Metody pro získání teplotních extrémů a průměrů
    private string GetMinTemperature()
    {
        if (WeatherData == null || !WeatherData.Any())
            return "N/A";
            
        return WeatherData.Min(d => d.TemperatureOut)?.ToString("0.0", CultureInfo.InvariantCulture).Replace('.', ',') ?? "N/A";
    }
    
    private string GetAvgTemperature()
    {
        if (WeatherData == null || !WeatherData.Any())
            return "N/A";
            
        var avgValues = WeatherData.Select(d => d.AvgTemperature).Where(t => t.HasValue);
        if (!avgValues.Any())
            return "N/A";
            
        return avgValues.Average()?.ToString("0.0", CultureInfo.InvariantCulture).Replace('.', ',') ?? "N/A";
    }
    
    private string GetMaxTemperature()
    {
        if (WeatherData == null || !WeatherData.Any())
            return "N/A";
            
        return WeatherData.Max(d => d.MaxTemperature)?.ToString("0.0", CultureInfo.InvariantCulture).Replace('.', ',') ?? "N/A";
    }
} 